<!DOCTYPE html>
<html>
<head>
	<title>Show me the mask</title>
        <!-- Import T-map -->
        <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5ea6a3424c4aff7291f51b4c796677ff&libraries=services"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src='http://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.js'></script>
        <script src='http://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js'></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.js'></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.bundle.min.js'></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/ui-lightness/jquery-ui.css">
        <style type="text/css">
        	html, body {
        		width: 100%;
        		height: 100%;
        	}
        	.search {
                border: 0;
                line-height: 26px;
                background: #253d6d;
                background-image: none;
                color: #ffffff !important;
                border-radius: 5px;
                display: inline-block;
                padding: 0 5px;
                min-width: 30px;
                text-align:center;
                box-shadow: none;
            }
            .place {
            	background: white;
            	border: none;
            	width: 100%;
            	text-align: left;
            }
            .overay_info {
            	padding: 8px;
            	border: 1px solid rgb(118, 129, 168);
            	float:left;
            	position: relative;
            	background-color:#fff;
            }
            ul {
            	list-style: none;
            }
            li {
                text-align: -webkit-match-parent;
            }
        </style>
</head>
<body>
    <div id="map" style="width:100%;height:100%;">
	    <nav style="position: absolute; top: 0; width: 100%; height: 65px; padding: 0 10px 0 10px; margin:0; z-index: 10000; background: rgb(0,0,0);"><h1 style="color: white;"><b>Show me the mask</b></h1>
	    	<button style="background: rgba(255, 255, 255, 0); right: 10px; top: 10px; position: absolute; border: none;"><img style=" width: 40px; height: 40px;" src="images/info.png"></button>
	    </nav>
        <div id="floating_search" style="position: absolute; background: white; padding: 10px; border-radius: 20px; width: 90%; height: 50px; top: 75px; right: 5%; left: 5%; z-index: 10000;">
            <input type="text" placeholder="검색할 장소를 입력하세요" name="search" id="search" style="border:none; padding: 0 10px 0 10px; width: 90%; height: 90%;">
            <button class="search" id="searchButton" style="background: rgba(255, 255, 255, 0); float: right; height: 70%;"><img src="images/search.png" alt=""></button>
        </div>
        <div id="searchListDiv" style="display: none; overflow-y: auto; background: rgb(255, 255, 255); position: absolute; padding: 10px; border-radius: 0 0 20px 20px; height: 40%; width: 90%; top: 115px; z-index: 1000;right: 5%; left: 5%; ">
        	<!-- 검색 결과 들어갈 div -->
        </div>
        <div style="position: absolute; z-index: 1000; left: 10px; bottom: 20px; padding: 10px; border-radius: 10px; background: white; ">
        	<img src="images/maskinfo.png" style="width: 150px; height: 205px;">
        </div>
        <!-- 현재위치로 이동시켜주는 button -->
        <button id="current_location" style="position: absolute; left: 10px; top: 130px; width: 50px; height: 50px; border-radius: 50%; z-index: 1000; background: rgb(255, 255, 255); border: none;"><img src="images/aim.png"></button>
    </div>

	<script type="text/javascript">
		// javascript here!
		var lat, lon;
		var infowindow;
		let xhr = new XMLHttpRequest();
		var mapContainer = document.getElementById('map'); // 지도를 표시할 div 

	    mapOption = { 
	        center: new kakao.maps.LatLng(35.912428, 128.807808), // 지도의 중심좌표
	        level: 3, // 지도의 확대 레벨 
	        maxLevel: 4
	    };

	    var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다
	    var mapTypeControl = new kakao.maps.MapTypeControl();
	    var zoomControl = new kakao.maps.ZoomControl();
	    var resultPlace = new kakao.maps.services.Places();
	    var current_var;
	    var searchResultList = document.getElementById("searchListDiv");
	    var floatingSearch = document.getElementById("floating_search");
	    var placeArray = [];
	    var resultMarker;


		map.addControl(zoomControl, kakao.maps.ControlPosition.BOTTOMRIGHT);
	    map.addControl(mapTypeControl, kakao.maps.ControlPosition.BOTTOMRIGHT);

		getCurrentLocation();

		$("#search").on("change keyup paste", function() {
			current_var = $(this).val();
			if (!current_var.replace(/^\s+|\s+$/g, '')) {
				$("#searchListDiv").slideUp("fast");
				floatingSearch.style.borderRadius = "20px";
			} else {
				$("#searchListDiv").slideDown("fast");
				floatingSearch.style.borderRadius = "20px 20px 0 0";
				resultPlace.keywordSearch(current_var, placesSearch);
			}
		});
		
		$("#searchButton").click(function() {
			if (!current_var.replace(/^\s+|\s+$/g, '')) {
			        alert('키워드를 입력해주세요!');
			        return false;
			    }
			else
				resultPlace.keywordSearch(current_var, placesSearchCB);
		});

		function maskSearch (latitude, longitude) {
			let jsonURL = "https://8oi9s0nnth.apigw.ntruss.com/corona19-masks/v1/storesByGeo/json?lat="+ latitude +"&lng="+ longitude +"&m=2000";
			xhr.open('GET', jsonURL);
	        xhr.send();
	        //응답을 받으면 함수 실행
	        xhr.onload = () => {
	            //응답받은 문자열을 자바스크립트 객체로 변환 해 준다.
	            let superHeroes = JSON.parse(xhr.response); 
	            parseJsonResult(superHeroes);
	        }
		}

		function placesSearch(data, status, pagination) {
		    if (status === kakao.maps.services.Status.OK) {
		        searchResultList.innerHTML = '';
		       	placeArray = data;
		        for (var i = 0; i < data.length; i ++) {
		        	// console.log(data[i]);

		        	searchResultList.innerHTML += "<button class='place' onclick='buttonClick(this)' id='place" + i + "' style='border-bottom: 1px solid #efefef;'><b>" + data[i].place_name + "</b><br>"
		        	+ data[i].address_name + "</button>";
		        }
		    } else if (status === kakao.maps.services.Status.ERROR) {

		        alert('검색 결과 중 오류가 발생했습니다.');
		        return;

		    }

		}

		function placesSearchCB(data, status, pagination) {
		    if (status === kakao.maps.services.Status.OK) {
		        searchResultList.innerHTML = '';
		       	placeArray = data;
		        for (var i = 0; i < data.length; i ++) {
		        console.log(data[i]);
		        	var placePosition = new kakao.maps.LatLng(data[i].y, data[i].x);

		        	searchResultList.innerHTML += "<button class='place' onclick='buttonClick(this)' id='place" + i + "' style='border-bottom: 1px solid #efefef;'><b>" + data[i].place_name + "</b><br>"
		        	+ data[i].address_name + "</button>";
		        }

		    } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
		        alert('검색 결과가 존재하지 않습니다.');
		        return;
		    } else if (status === kakao.maps.services.Status.ERROR) {
		        alert('검색 결과 중 오류가 발생했습니다.');
		        return;
		    }
		}

		function buttonClick (button) {
			$("#searchListDiv").slideUp("fast");
			floatingSearch.style.borderRadius = "20px";
			goSearchResult(placeArray[button.id[5]]);
		}

		function goSearchResult (data) {
			console.log(data);
			document.getElementById("search").value = data.place_name;

			var locPosition = new kakao.maps.LatLng(data.y, data.x);
	        var imageSrc = 'images/marker10.png', // 마커이미지의 주소입니다    
	        imageSize = new kakao.maps.Size(60, 65), // 마커이미지의 크기입니다
	        imageOption = {offset: new kakao.maps.Point(31, 59)}; // 마커이미지의 옵션입니다. 마커의 좌표와 일치시킬 이미지 안에서의 좌표를 설정합니다.
	  
	        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);

	        if (resultMarker == null) {
	        	// 마커를 생성합니다
		        resultMarker = new kakao.maps.Marker({
		            position: locPosition, 
		            image: markerImage // 마커이미지 설정 
				});

				// 마커가 지도 위에 표시되도록 설정합니다
				resultMarker.setMap(map); 
	        } else {
	        	resultMarker.setPosition(locPosition);
	        }
	        

			map.setCenter(locPosition);
			maskSearch(data.y, data.x);
		}

		function getCurrentLocation () {
			if (navigator.geolocation) {
			    // GeoLocation을 이용해서 접속 위치를 얻어옵니다
			    navigator.geolocation.getCurrentPosition(function(position) {
			        
			        lat = position.coords.latitude; // 위도
			        lon = position.coords.longitude; // 경도
			        
			        var locPosition = new kakao.maps.LatLng(lat, lon);
			        var imageSrc = 'images/marker10.png', // 마커이미지의 주소입니다    
			        imageSize = new kakao.maps.Size(60, 65), // 마커이미지의 크기입니다
			        imageOption = {offset: new kakao.maps.Point(31, 59)}; // 마커이미지의 옵션입니다. 마커의 좌표와 일치시킬 이미지 안에서의 좌표를 설정합니다.
			  
			        // 마커의 이미지정보를 가지고 있는 마커이미지를 생성합니다
			        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption),
			            markerPosition = new kakao.maps.LatLng(lat, lon); // 마커가 표시될 위치입니다

			        // 마커를 생성합니다
			        var marker = new kakao.maps.Marker({
			            position: markerPosition, 
			            image: markerImage // 마커이미지 설정 
					});

					// 마커가 지도 위에 표시되도록 설정합니다
					marker.setMap(map); 

					// 지도 중심좌표를 접속위치로 변경합니다
					map.setCenter(locPosition);

			    	maskSearch(lat, lon);
				});
			} else { // HTML5의 GeoLocation을 사용할 수 없을때 마커 표시 위치와 인포윈도우 내용을 설정합니다
			    
			    var locPosition = new kakao.maps.LatLng(35.912428, 128.807808),    
			        message = 'geolocation을 사용할수 없어요..'
			        
			    displayMarker(locPosition, message);

			}
		}
		$("#current_location").click(function() {
			if (lat != null) {
				map.setCenter(new kakao.maps.LatLng(lat, lon));
			} else {
				getCurrentLocation();
			}
		});

		kakao.maps.event.addListener(map, 'dragend', function() {        
			    // 지도 중심좌표를 얻어옵니다 
			    var latlng = map.getCenter(); 

			    maskSearch(latlng.getLat(), latlng.getLng());
			    infowindow.close();
		    
		});

		function parseJsonResult(jsonObj) {
			let heroes = jsonObj['stores'];

	        heroes.forEach(element => {
		        var locPosition = new kakao.maps.LatLng(element.lat, element.lng);
		        var imageSrc_red = 'images/mask_red.png', 
		        imageSrc_yellow = 'images/mask_yellow.png',
		        imageSrc_green = 'images/mask_green.png',
		        imageSrc_gray = 'images/mask_gray2.png',// 마커이미지의 주소입니다
	        	imageSize = new kakao.maps.Size(60, 65), // 마커이미지의 크기입니다
	        	imageOption = {offset: new kakao.maps.Point(31, 59)};

				var markerImageRed = new kakao.maps.MarkerImage(imageSrc_red, imageSize, imageOption),
				markerImageYellow = new kakao.maps.MarkerImage(imageSrc_yellow, imageSize, imageOption),
				markerImageGreen = new kakao.maps.MarkerImage(imageSrc_green, imageSize, imageOption),
				markerImageGray = new kakao.maps.MarkerImage(imageSrc_gray, imageSize, imageOption),
				markerPosition = new kakao.maps.LatLng(element.lat, element.lng);
				var markerImage;
				if (element.remain_stat == "plenty")
					markerImage = markerImageGreen;
				else if (element.remain_stat == "some")
					markerImage = markerImageYellow;
				else if (element.remain_stat == "few")
					markerImage = markerImageRed;
				else
					markerImage = markerImageGray;
	            var marker = new kakao.maps.Marker({
		            position: locPosition, 
		            image: markerImage
				});
				marker.setMap(map); 
				var iwContent = '<div class="overay_info"><span class="place_name"><strong>' + element.name + '</strong></span><br><span class="place_addr">' + element.addr + '</span></div>', // 인포윈도우에 표출될 내용으로 HTML 문자열이나 document element가 가능합니다
    			iwRemoveable = true; // removeable 속성을 ture 로 설정하면 인포윈도우를 닫을 수 있는 x버튼이 표시됩니다
    			infowindow = new kakao.maps.InfoWindow({
				    content : iwContent,
				    removable : iwRemoveable
				});
				kakao.maps.event.addListener(marker, 'click', function() {
				      // 마커 위에 인포윈도우를 표시합니다
				      infowindow.open(map, marker);  
				      // infowindow.setMap(map);
				});

	        });
		}
	</script>
</body>
</html>